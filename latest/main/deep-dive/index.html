<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>MDK Features &mdash; Microservices Development Kit 2.0 documentation</title>
    
    <link rel="stylesheet" href="../_static/css/style.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../',
        VERSION:     '2.0',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../_static/jquery.js"></script>
    <script type="text/javascript" src="../_static/underscore.js"></script>
    <script type="text/javascript" src="../_static/doctools.js"></script>
    <link rel="top" title="Microservices Development Kit 2.0 documentation" href="../index.html" />
    <link rel="next" title="Web Framework Integration" href="../webframeworks.html" />
    <link rel="prev" title="Getting Started" href="../getting-started/index.html" />
   
  
  <link href='https://fonts.googleapis.com/css?family=Source+Sans+Pro:400,300,600' rel='stylesheet' type='text/css'>
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document"><header class="dw-header" role="banner">
    <div class="dw-headerwrapper group">
        <div class="dw-sidebar">
            <a href="../index.html">
                <img class="dw-logo" src="../_static/img/logo-datawire.png" alt="Datawire">
            </a>
        </div>
        <div class="dw-search group" role="search">
            <form class="dw-searchform" action="../search.html" method="get">
                <input type="text" placeholder="Search" name="q" />
                <input type="hidden" name="check_keywords" value="yes" />
                <input type="hidden" name="area" value="default" />
            </form>
        </div>
    </div>
</header>

    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a
            href="../webframeworks.html"
            title="Web Framework Integration"
            accesskey="N">
              
              next
              &rarr;
          </a></li>
        <li class="right" >
          <a
            href="../getting-started/index.html"
            title="Getting Started"
            accesskey="P">
              &larr;
              previous
              
          </a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Microservices Development Kit 2.0 documentation</a> &raquo;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="mdk-features">
<h1>MDK Features<a class="headerlink" href="#mdk-features" title="Permalink to this headline">¶</a></h1>
<div class="section" id="introduction">
<h2>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h2>
<p>The Datawire Microservices Development Kit (MDK) offers sophisticated capabilities for quickly creating
and connecting microservices in your existing development environment. Its
API is very simple to use in both new and existing applications.</p>
<p>Datawire makes available a number of cloud-based services that you can
quickly leverage without having to run any extra infrastructure within your
own environment. For example, the Datawire Discovery and Tracing services are
always running in the cloud and available for your microservices developers
to use via the MDK.</p>
<p>Below, we&#8217;ll cover the steps required to create and register a microservice
with the Datawire Discovery system, and then show how clients can then locate
the service once it&#8217;s running.</p>
<p>Note: the code samples below are in Python, but you can see similar samples
for Java, JavaScript, and Ruby in the <a class="reference external" href="https://github.com/datawire/mdk-docs/tree/master/examples">MDK Examples</a> repository.</p>
</div>
<div class="section" id="setting-up-your-environment">
<h2>Setting Up Your Environment<a class="headerlink" href="#setting-up-your-environment" title="Permalink to this headline">¶</a></h2>
<p>If you haven&#8217;t already created an account on Mission Control, create an account
at <a class="reference external" href="https://app.datawire.io">https://app.datawire.io</a>.
Exit the wizard, click on the &#8220;Copy Token&#8221; link on the left hand navigation bar
and then paste into your terminal.
You should see something like <code class="docutils literal"><span class="pre">export</span> <span class="pre">DATAWIRE_TOKEN=&lt;long</span> <span class="pre">string</span> <span class="pre">here&gt;</span></code>;
this will set the security token for your session. You&#8217;ll need that token set
in each terminal window that you use.</p>
</div>
<div class="section" id="creating-a-microservice-with-the-mdk">
<h2>Creating a Microservice with the MDK<a class="headerlink" href="#creating-a-microservice-with-the-mdk" title="Permalink to this headline">¶</a></h2>
<p>Let&#8217;s take a simple Flask-based application and convert it to a Datawire
microservice using the MDK. Here&#8217;s the code for a plain Flask-based &#8220;Hello
World&#8221; microservice:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;Hello World!</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
</pre></div>
</div>
<p>Save this file as <code class="docutils literal"><span class="pre">microservice.py</span></code> and run it on port 7000 using the
command:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">python microservice.py 127.0.0.1 7000</span>
</pre></div>
</div>
<p>Then, call the service using <code class="docutils literal"><span class="pre">curl</span></code>:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">curl http://127.0.0.1:7000</span>
</pre></div>
</div>
<p>You should see the service return the string <code class="code docutils literal"><span class="pre">Hello</span> <span class="pre">World!</span></code>.</p>
<p>Importantly, any component that wishes to call this service also needs to
know the host and port that it&#8217;s running on. Let&#8217;s fix that problem using the
MDK and the Datawire Discovery Service.</p>
<p>The code below adds a couple of lines to import the MDK and make the service
register its endpoint address with Datawire. Replace the contents of
<code class="docutils literal"><span class="pre">microservice.py</span></code> with it:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>

<span class="c1"># Add the import of mdk and atexit</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">mdk</span><span class="o">,</span> <span class="nn">atexit</span>
<span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>

<span class="c1"># Build the URL which we will register with Datawire</span>
<span class="n">addr</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;Hello World (via Datawire)!</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="c1"># Start the MDK and register our service information with Datawire</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mdk</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>

    <span class="c1"># Register a shutdown hook for fast de-registration from Datawire</span>
    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>

    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
</pre></div>
</div>
<p>Now re-run the microservice with this command:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">python microservice.py 127.0.0.1 7000</span>
</pre></div>
</div>
<p>With just a few extra lines of code, we successfully instrumented our
original Flask-based microservice with the Datawire MDK. When we run this
application, it registers itself with the Datawire Discovery Service, and
will show up on the Datawire Mission Control UI when it&#8217;s running.</p>
<p>In practice you&#8217;ll want to use the MDK&#8217;s <a class="reference internal" href="../webframeworks.html"><span class="doc">web framework integration</span></a>, which reduce the amount of boilerplate you have to write.</p>
</div>
<div class="section" id="service-discovery">
<h2>Service Discovery<a class="headerlink" href="#service-discovery" title="Permalink to this headline">¶</a></h2>
<p>Now let&#8217;s see how clients will find and call our microservice using the Datawire
Discovery Service.</p>
<p>With your service running, launch a Python interpreter in your terminal (making
sure that the <code class="docutils literal"><span class="pre">DATAWIRE_TOKEN</span></code> environment variable is set correctly), and
run the following code:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mdk</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">mdk</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">session</span><span class="p">()</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>It should print the value <code class="docutils literal"><span class="pre">http://127.0.0.1:7000</span></code>. That value was returned
by the Datawire Discovery Service as the only available endpoint for the
<code class="docutils literal"><span class="pre">hello</span></code> service.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you&#8217;re using a <a class="reference internal" href="../webframeworks.html"><span class="doc">web framework integration</span></a> you should use the session object that will be setup by your chosen integration.
E.g. Flask has a session on <code class="docutils literal"><span class="pre">flask.g.mdk_session</span></code>.</p>
</div>
</div>
<div class="section" id="load-balancing">
<h2>Load Balancing<a class="headerlink" href="#load-balancing" title="Permalink to this headline">¶</a></h2>
<p>With the other microservice still running on port 7000, let&#8217;s now run another
instance of the microservice on port 7001. Note: if you start a new terminal
window, be sure to set your <code class="docutils literal"><span class="pre">DATAWIRE_TOKEN</span></code> environment variable there too.</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">python microservice.py 127.0.0.1 7001</span>
</pre></div>
</div>
<p>If you now look at the Datawire Mission Control web console, you&#8217;ll see that
the <code class="docutils literal"><span class="pre">hello</span></code> microservice has 2 active 1.0 nodes listed.</p>
<p>Datawire&#8217;s Discovery system will now load balance clients across the nodes that
are active and healthy. Launch a <code class="docutils literal"><span class="pre">python</span></code> interpreter and run the following
commands:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">mdk</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">mdk</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
<span class="k">print</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="k">print</span><span class="p">(</span><span class="n">session</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">address</span><span class="p">)</span>
<span class="n">m</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>You should see the <code class="docutils literal"><span class="pre">resolve()</span></code> calls returning different results each time
as the Discovery system round-robins between the two available microservice
addresses (on ports 7000 and 7001).</p>
<p>If you kill one of your microservice instances and retry the above, you&#8217;ll see
only one address get returned. Of course, if you launch even more microservices
on other ports, the Discovery system will begin to return those new addresses
too.</p>
</div>
<div class="section" id="microservices-calling-microservices">
<h2>Microservices calling Microservices<a class="headerlink" href="#microservices-calling-microservices" title="Permalink to this headline">¶</a></h2>
<p>Microservices normally call other microservices. Doing so with the Datawire MDK
and the associated Service Discovery system can be used to avoid having to
deploy expensive per-service load balancers, cumbersome sidecar proxies, or
other conventional pieces of software infrastructure.</p>
<p>The code below illustrates how to resiliently call another microservice
that is first located using the Service Discovery API in the MDK. It loops
every second, resolving a new address each time. The resolution is extremely
fast (and completely local) since the MDK synchronizes the service routing table
with the Discovery service in the cloud, and it maintains a local copy of the
always up-to-date service table in-process.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">requests</span><span class="o">,</span> <span class="nn">time</span><span class="o">,</span> <span class="nn">mdk</span>

<span class="k">def</span> <span class="nf">main</span><span class="p">(</span><span class="n">mdk</span><span class="p">,</span> <span class="n">service</span><span class="p">,</span> <span class="n">version</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># Start a new session</span>
        <span class="n">ssn</span> <span class="o">=</span> <span class="n">mdk</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>

        <span class="c1"># Resolve the service name to a real endpoint address</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">ssn</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span><span class="o">.</span><span class="n">address</span>

        <span class="c1"># Make the request, passing in our request tracing header</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="n">mdk</span><span class="o">.</span><span class="n">CONTEXT_HEADER</span><span class="p">:</span> <span class="n">ssn</span><span class="o">.</span><span class="n">inject</span><span class="p">()})</span>
        <span class="k">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> =&gt; </span><span class="si">%d</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">r</span><span class="o">.</span><span class="n">text</span><span class="p">))</span>

        <span class="c1"># Wait before we resolve a new address and call again</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;usage: client service_name&quot;</span><span class="p">);</span>

    <span class="n">service_name</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">MDK</span> <span class="o">=</span> <span class="n">mdk</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">main</span><span class="p">(</span><span class="n">MDK</span><span class="p">,</span> <span class="n">service_name</span><span class="p">,</span> <span class="s2">&quot;1.0.0&quot;</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">MDK</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
</pre></div>
</div>
<p>First, save the above code as <code class="docutils literal"><span class="pre">client.py</span></code>. Then, run at least a couple of
<code class="docutils literal"><span class="pre">hello</span></code> microservices locally. Finally, run the code above with the command:</p>
<div class="highlight-console"><div class="highlight"><pre><span></span><span class="go">python client.py hello</span>
</pre></div>
</div>
<p>You should see a new address chosen each second as the load balancing logic
in the MDK round-robins through the set of available service instance URLs.</p>
<p>In practice you&#8217;ll want to use the MDK <a class="reference internal" href="../webclients.html"><span class="doc">HTTP client integration</span></a> when possible, to reduce the amount of boilerplate you have to write.</p>
</div>
<div class="section" id="distributed-tracing">
<h2>Distributed Tracing<a class="headerlink" href="#distributed-tracing" title="Permalink to this headline">¶</a></h2>
<p>Datawire&#8217;s system includes a facility for distributed inter-microservice
request tracing through the collection of correlated log messages within the
Mission Control interface.</p>
<p>Let&#8217;s take our existing <code class="docutils literal"><span class="pre">microservice.py</span></code> code and add two lines into
the implementation of the hello() function to log an INFO message to the
Datawire cloud:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">import</span> <span class="nn">sys</span><span class="o">,</span> <span class="nn">mdk</span><span class="o">,</span> <span class="nn">atexit</span>
<span class="n">host</span><span class="p">,</span> <span class="n">port</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]</span>
<span class="n">addr</span> <span class="o">=</span> <span class="s2">&quot;http://</span><span class="si">%s</span><span class="s2">:</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>

<span class="kn">from</span> <span class="nn">flask</span> <span class="kn">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">request</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="n">__name__</span><span class="p">)</span>

<span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="c1"># Join the logging context from the request, if possible.</span>
    <span class="c1"># This will collect all cross-service calls for a particular</span>
    <span class="c1"># request into the same group within Datawire Mission Control.</span>
    <span class="n">session</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">CONTEXT_HEADER</span><span class="p">))</span>

    <span class="c1"># Log an INFO-level trace message</span>
    <span class="n">session</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot;Received a request.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="s2">&quot;Hello World (via Datawire)!</span><span class="se">\n</span><span class="s2">&quot;</span>

<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">m</span> <span class="o">=</span> <span class="n">mdk</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
    <span class="n">m</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="s2">&quot;hello&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">,</span> <span class="n">addr</span><span class="p">)</span>
    <span class="n">atexit</span><span class="o">.</span><span class="n">register</span><span class="p">(</span><span class="n">m</span><span class="o">.</span><span class="n">stop</span><span class="p">)</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">host</span><span class="o">=</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="n">port</span><span class="p">)</span>
</pre></div>
</div>
<p>Run this microservice on port 7000, and use <code class="docutils literal"><span class="pre">curl</span> <span class="pre">http://127.0.0.1:7000</span></code> to
call it. Then, switch over to your browser and view the Logs panel in
Datawire Mission Control. You should see a trace message group for the
current time, and if you expand it, you should see the <code class="docutils literal"><span class="pre">Received</span> <span class="pre">a</span> <span class="pre">request</span></code>
message that was logged at INFO level.</p>
</div>
<div class="section" id="cross-service-tracing">
<h2>Cross-Service Tracing<a class="headerlink" href="#cross-service-tracing" title="Permalink to this headline">¶</a></h2>
<p>The ability to track request flow across multiple microservices is a very
helpful feature when trying to diagnose an issue in a production environment.
Datawire&#8217;s Tracing Service makes it easy to see how a request flows all
the way through a graph of microservices.</p>
<p>Cross-service tracing in Datawire is just an extension of the distributed
tracing model described earlier. By simply making sure that all requests
sent to another microservice include a special context header, the log
messages created as the request flow moves around the system can be tracked
and grouped together in Datawire Mission Control.</p>
<p>For example, if microservice A wishes to call an API on microservice B, the
code in microservice A that makes that call simply needs to add a new HTTP header to its outbound request to B, as follows:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Start a new session</span>
<span class="n">ssn</span> <span class="o">=</span> <span class="n">mdk</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>

<span class="c1"># Get an active address for service B via Discovery</span>
<span class="n">url</span> <span class="o">=</span> <span class="n">ssn</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="s2">&quot;B&quot;</span><span class="p">,</span> <span class="s2">&quot;1.0&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">address</span>

<span class="c1"># Make the request to service B with the context header added</span>
<span class="n">r</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="n">mdk</span><span class="o">.</span><span class="n">CONTEXT_HEADER</span><span class="p">:</span> <span class="n">ssn</span><span class="o">.</span><span class="n">externalize</span><span class="p">()})</span>
</pre></div>
</div>
<p>Now, the outbound HTTP request to microservice B will include an extra
Datawire-specific header that identifies the request flow with a unique ID.
When any other microservices log any messages under the same ID, those messages
will be visible together in Mission Control. The code to do so within
service B is trivial:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="nd">@app.route</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="c1"># Join the logging context from the request, if possible:</span>
    <span class="n">ssn</span> <span class="o">=</span> <span class="n">mdk</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">mdk</span><span class="o">.</span><span class="n">CONTEXT_HEADER</span><span class="p">))</span>
    <span class="n">ssn</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">app</span><span class="o">.</span><span class="n">service_name</span><span class="p">,</span> <span class="s2">&quot;Received a request.&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;Hello World!&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="circuit-breakers">
<h2>Circuit Breakers<a class="headerlink" href="#circuit-breakers" title="Permalink to this headline">¶</a></h2>
<p>Circuit breakers are powerful abstractions that help limit the scope of failure. The MDK includes native support for circuit breakers that are integrated with service discovery. For example, imagine service A calls service B, and service B returns a result that triggers an exception in A. A can blacklist service B for a certain period of time, and fall back to an older version of B, periodically testing to see if the new version of B returns the proper result. Here is an example of a circuit breaker:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">ssn</span><span class="o">.</span><span class="n">start_interaction</span><span class="p">()</span>
<span class="n">node</span> <span class="o">=</span> <span class="n">ssn</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">service</span><span class="p">,</span> <span class="n">version</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
     <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">address</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="n">m</span><span class="o">.</span><span class="n">CONTEXT_HEADER</span><span class="p">:</span> <span class="n">ssn</span><span class="o">.</span><span class="n">inject</span><span class="p">()},</span> <span class="n">timeout</span><span class="o">=</span><span class="mf">3.0</span><span class="p">)</span>
     <span class="n">ssn</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> initiating request to </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">node</span><span class="p">))</span>
     <span class="n">responder_data</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
     <span class="n">ssn</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> got response </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">responder_data</span><span class="p">[</span><span class="s1">&#39;request_id&#39;</span><span class="p">]))</span>
     <span class="n">result</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">responder_data</span><span class="p">)</span>
     <span class="n">ssn</span><span class="o">.</span><span class="n">finish_interaction</span><span class="p">()</span>
<span class="k">except</span><span class="p">:</span>
     <span class="n">ssn</span><span class="o">.</span><span class="n">fail_interaction</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">, </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">config</span><span class="o">.</span><span class="n">service</span><span class="p">,</span> <span class="n">config</span><span class="o">.</span><span class="n">node</span><span class="p">,</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">()))</span>
     <span class="n">result</span><span class="p">[</span><span class="s1">&#39;requests&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;ERROR(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">node</span><span class="p">)</span>
</pre></div>
</div>
<p>There are three methods used to wrap a remote call with a circuit breaker. To start a circuit breaker, use the <code class="docutils literal"><span class="pre">start_interaction</span></code> method. This method starts the interaction with a remote service, and tracks the different services that are invoked during the interaction. This could be a single service, or multiple services. When the interaction has successfully completed, the <code class="docutils literal"><span class="pre">finish_interaction</span></code> method is called, which will record the interaction as successfully completing. If an interaction fails, the <code class="docutils literal"><span class="pre">fail_interaction</span></code> method is called, which will record a failed interaction. With a failed interaction, the services that are invoked are blacklisted.  By default, three failures will trigger the circuit breaker to blacklist the services for 30 seconds.</p>
</div>
<div class="section" id="distributed-timeouts">
<h2>Distributed Timeouts<a class="headerlink" href="#distributed-timeouts" title="Permalink to this headline">¶</a></h2>
<p>In order to build a robust distributed system you need not only circuit breakers in case of errors, but also timeouts in case a request never returns a response.
The MDK allows you to attach a deadline to an MDK session, and that deadline will be tracked across all the processes that use that particular session.
At any time you can query the session for the remaining time and use that as a parameter to APIs that take a timeout argument.</p>
<p>For example:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Do a HTTP request with timeout based on the MDK session deadline:</span>
<span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">ssn</span><span class="o">.</span><span class="n">getRemainingTime</span><span class="p">())</span>
</pre></div>
</div>
<p>Servers should always set a default deadline which will be applied to both incoming and newly created sessions.
If the incoming session already has a deadline set then the lower of the two deadlines will be used.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">mdk</span><span class="o">.</span><span class="n">setDefaultDeadline</span><span class="p">(</span><span class="mf">10.0</span><span class="p">)</span>
</pre></div>
</div>
<p>You can also set a per-session deadline.
Again, if a deadline was already set the lower of the two will be used.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">mdk</span><span class="o">.</span><span class="n">setDeadline</span><span class="p">(</span><span class="mf">5.0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="custom-properties-on-distributed-sessions">
<h2>Custom Properties on Distributed Sessions<a class="headerlink" href="#custom-properties-on-distributed-sessions" title="Permalink to this headline">¶</a></h2>
<p>Besides deadlines you can also set arbitrary properties on a distributed session.
Process P1 can set a property on the session and then sends it to process P2.
Notice the use of a prefix <code class="docutils literal"><span class="pre">&quot;demoapp&quot;</span></code> added to the <code class="docutils literal"><span class="pre">&quot;items&quot;</span></code> key; this ensures the property doesn&#8217;t conflict with built-in properties or properties from other applications.</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="c1"># Create a session:</span>
<span class="n">session</span> <span class="o">=</span> <span class="n">mdk</span><span class="o">.</span><span class="n">session</span><span class="p">()</span>
<span class="c1"># Set a property; any JSON-encodable value can be used:</span>
<span class="n">session</span><span class="o">.</span><span class="n">setProperty</span><span class="p">(</span><span class="s2">&quot;demoapp:items&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

<span class="c1"># Serialize the session for transmission to another process:</span>
<span class="k">return</span> <span class="n">session</span><span class="o">.</span><span class="n">externalize</span><span class="p">()</span>
</pre></div>
</div>
<p>Process P2 can then check and retrieve properties:</p>
<div class="highlight-python"><div class="highlight"><pre><span></span><span class="n">session</span> <span class="o">=</span> <span class="n">mdk</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">encoded_session</span><span class="p">)</span>
<span class="n">session</span><span class="o">.</span><span class="n">hasProperty</span><span class="p">(</span><span class="s2">&quot;demoapp:items&quot;</span><span class="p">)</span>  <span class="c1"># returns True</span>
<span class="n">session</span><span class="o">.</span><span class="n">getProperty</span><span class="p">(</span><span class="s2">&quot;demoapp:items&quot;</span><span class="p">)</span>  <span class="c1"># returns [1, 2]</span>
</pre></div>
</div>
</div>
<div class="section" id="derived-sessions">
<h2>Derived Sessions<a class="headerlink" href="#derived-sessions" title="Permalink to this headline">¶</a></h2>
<p>The distributed session and tracing mechanism described in previous sections is intended for RPC or other remote API calls.
In particular the result of <code class="docutils literal"><span class="pre">Session.externalize()</span></code> should only be used once.
In other cases you might want to track the relationship between operations that result from 1-&gt;N broadcasts.
For example, you might publish a message to a pub/sub system where multiple subscribers receive a message.</p>
<p>For these cases the MDK provides &#8220;derived&#8221; sessions.
Instead of calling <code class="docutils literal"><span class="pre">mdk.join(encoded_session)</span></code> use <code class="docutils literal"><span class="pre">mdk.derive(encoded_session)</span></code> instead.</p>
<p>A derived session is a new session, but when it created it logs its relationship with the parent session.
It also inherits almost all properties from the original session.
The only property that isn&#8217;t inherited is the deadline, because asynchronous systems like pub/sub can take an arbitrary amount of time before the subscriber gets messages.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="../index.html">Table Of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">MDK Features</a><ul>
<li><a class="reference internal" href="#introduction">Introduction</a></li>
<li><a class="reference internal" href="#setting-up-your-environment">Setting Up Your Environment</a></li>
<li><a class="reference internal" href="#creating-a-microservice-with-the-mdk">Creating a Microservice with the MDK</a></li>
<li><a class="reference internal" href="#service-discovery">Service Discovery</a></li>
<li><a class="reference internal" href="#load-balancing">Load Balancing</a></li>
<li><a class="reference internal" href="#microservices-calling-microservices">Microservices calling Microservices</a></li>
<li><a class="reference internal" href="#distributed-tracing">Distributed Tracing</a></li>
<li><a class="reference internal" href="#cross-service-tracing">Cross-Service Tracing</a></li>
<li><a class="reference internal" href="#circuit-breakers">Circuit Breakers</a></li>
<li><a class="reference internal" href="#distributed-timeouts">Distributed Timeouts</a></li>
<li><a class="reference internal" href="#custom-properties-on-distributed-sessions">Custom Properties on Distributed Sessions</a></li>
<li><a class="reference internal" href="#derived-sessions">Derived Sessions</a></li>
</ul>
</li>
</ul>
<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../index.html">Documentation overview</a><ul>
      <li>Previous: <a href="../getting-started/index.html" title="previous chapter">Getting Started</a></li>
      <li>Next: <a href="../webframeworks.html" title="next chapter">Web Framework Integration</a></li>
  </ul></li>
</ul>
</div>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="../_sources/deep-dive/index.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../search.html" method="get">
      <div><input type="text" name="q" /></div>
      <div><input type="submit" value="Go" /></div>
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a
            href="../webframeworks.html"
            title="Web Framework Integration"
            >
              
              next
              &rarr;
          </a></li>
        <li class="right" >
          <a
            href="../getting-started/index.html"
            title="Getting Started"
            >
              &larr;
              previous
              
          </a> |</li>
        <li class="nav-item nav-item-0"><a href="../index.html">Microservices Development Kit 2.0 documentation</a> &raquo;</li> 
      </ul>
    </div>
    <div class="footer">
      &copy;2016, Datawire.io.
      
      |
      <a href="https://github.com/datawire/quark"
          rel="nofollow">GitHub Repository</a>
    </div>

    

    

    <script src="../_static/vendor/zc/ZeroClipboard.js" ></script>
    <script src="../_static/js/main.js" ></script>
  </body>
</html>